# Transformer拉曼光谱混合物分析系统 - 使用指南

## 目录

1. [环境安装](#环境安装)
2. [快速开始](#快速开始)
3. [详细使用说明](#详细使用说明)
4. [配置说明](#配置说明)
5. [常见问题](#常见问题)

---

## 环境安装

本项目支持两种环境配置方式：**Conda环境**（推荐）和**系统本地Python环境**。

### 系统要求

- **操作系统**: Windows 10/11
- **Python版本**: 3.8、3.9 或 3.10
- **内存**: 建议 ≥4GB
- **硬盘空间**: 约500MB

---

### 方法1: 使用Conda环境（推荐）

Conda能够提供独立的Python环境，避免依赖冲突。

#### 1.1 安装Anaconda或Miniconda

如果您还没有安装Conda，请先下载安装：

- **Anaconda**（完整版，约500MB）: https://www.anaconda.com/download
- **Miniconda**（精简版，约60MB）: https://docs.conda.io/en/latest/miniconda.html

#### 1.2 创建Conda环境

打开 **Anaconda Prompt** 或 **命令提示符**，执行以下命令：

```bash
# 创建名为 transformer_env 的Python 3.9环境
conda create -n transformer_env python=3.9 -y

# 激活环境
conda activate transformer_env
```

#### 1.3 安装项目依赖

进入项目目录并安装依赖：

```bash
# 进入项目目录
cd "D:\日常事务\李老师事务\2025编书系统工程与管理工程书\2025.09.07\所有程序\Transformer模型"

# 安装依赖
pip install -r requirements.txt
```

#### 1.4 验证安装

```bash
# 验证PyTorch安装
python -c "import torch; print('PyTorch版本:', torch.__version__)"

# 验证其他依赖
python -c "import numpy, matplotlib, sklearn; print('依赖安装成功')"
```

---

### 方法2: 使用系统本地Python环境

如果您已经在系统中安装了Python 3.8-3.10，可以直接使用本地环境。

#### 2.1 检查Python版本

打开命令提示符，检查Python版本：

```bash
python --version
```

确保版本为 3.8、3.9 或 3.10。

#### 2.2 创建虚拟环境（可选但推荐）

为了避免依赖冲突，建议创建虚拟环境：

```bash
# 进入项目目录
cd "D:\日常事务\李老师事务\2025编书系统工程与管理工程书\2025.09.07\所有程序\Transformer模型"

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate
```

#### 2.3 安装项目依赖

```bash
# 升级pip（推荐）
python -m pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt
```

#### 2.4 验证安装

```bash
# 验证安装
python -c "import torch, numpy, matplotlib; print('环境配置成功')"
```

---

## 快速开始

### 步骤1: 运行快速演示

```bash
python quick_start.py
```

**输出内容**：
- 数据生成演示
- 模型创建演示
- 前向传播演示
- 简单训练演示（5个epoch）

### 步骤2: 查看输出结果

脚本会显示：
- 模型架构信息（约81万参数）
- 数据集统计
- 训练损失变化

---

## 详细使用说明

### 1. 数据生成

#### 使用数据生成器

```python
from data import RamanMixtureGenerator

# 创建数据生成器（80个混合物）
generator = RamanMixtureGenerator(num_mixtures=80, random_seed=42)

# 生成并保存数据
spectra, component_labels, concentrations = generator.save_dataset('data')

# 数据形状:
#   spectra: (80, 1738) - 拉曼光谱
#   component_labels: (80, 5) - 成分标签（多标签）
#   concentrations: (80, 5) - 浓度（归一化）
```

#### 数据说明

- **光谱范围**: 400-2000 cm⁻¹，共1738个采样点
- **药物成分**: 阿司匹林、对乙酰氨基酚、咖啡因、布洛芬、萘普生
- **混合组成**: 每个混合物包含1-3种成分
- **浓度归一化**: 所有成分浓度之和为1

### 2. 模型创建

#### 创建Transformer模型

```python
from models import create_model
import config

# 创建模型
model = create_model()

# 设置设备
model = model.to(config.DEVICE)

# 查看模型信息
info = model.get_model_info()
print(f"总参数量: {info['total_parameters']:,}")
```

#### 模型架构说明

```
SpectrumTransformer
├── 嵌入层: 1 → 128维
├── 位置编码: 正弦余弦编码
├── Transformer编码器: 4层
│   ├── 多头自注意力: 8个头
│   ├── 前馈网络: 512维
│   └── Dropout: 0.1
├── 分类头: 128 → 64 → 5 (成分识别)
└── 回归头: 128 → 64 → 5 (浓度预测)
```

### 3. 预处理

#### 基线校正和归一化

```python
from utils.preprocessing import preprocess_spectrum

# 预处理光谱
processed_spectra = preprocess_spectrum(
    raw_spectra,
    baseline_correction_method='poly',  # 'poly' 或 'als'
    normalization_method='minmax',      # 'minmax' 或 'standard'
    degree=3                             # 多项式阶数
)
```

#### 可视化预处理效果

```python
import matplotlib.pyplot as plt

plt.figure(figsize=(12, 4))
plt.subplot(1, 2, 1)
plt.plot(raw_spectra[0])
plt.title('原始光谱')

plt.subplot(1, 2, 2)
plt.plot(processed_spectra[0])
plt.title('预处理后光谱')
plt.show()
```

### 4. 推理预测

#### 单样本预测

```python
from models import create_model
import torch
import numpy as np

# 加载模型
model = create_model()
model.load_state_dict(torch.load('saved_models/best_model.pth', weights_only=False))
model.eval()

# 预测
spectrum = np.load('data/spectra.npy')[0]  # 获取一个样本
spectrum_tensor = torch.FloatTensor(spectrum).unsqueeze(0)

with torch.no_grad():
    component_pred, concentration_pred = model(spectrum_tensor)

# 转换为numpy
components = (component_pred.numpy() > 0.5).astype(int)
concentrations = concentration_pred.numpy()

# 显示结果
print("识别的成分:")
for i, name in enumerate(config.COMPONENT_NAMES):
    if components[0, i] == 1:
        print(f"  {name}: {concentrations[0, i]:.3f}")
```

### 5. 性能评估

#### 评估指标计算

```python
from utils.metrics import evaluate_model, MultiTaskMetrics

# 评估模型
metrics, total_loss, class_loss, reg_loss = evaluate_model(
    model, test_loader, config.DEVICE
)

# 打印指标
metrics_calc = MultiTaskMetrics()
metrics_calc.print_metrics(metrics, prefix="测试集 ")
```

---

## 配置说明

### 修改配置文件 `config.py`

#### 1. 设备配置

```python
# CPU模式（默认）
DEVICE_MODE = 'cpu'

# 自动检测模式
DEVICE_MODE = 'auto'  # 优先使用GPU

# 强制GPU模式
DEVICE_MODE = 'gpu'
```

#### 2. 数据配置

```python
DATA_CONFIG = {
    'num_mixtures': 80,          # 混合物数量
    'min_components': 1,         # 最少成分数
    'max_components': 3,         # 最多成分数
    'noise_level': 0.01,         # 噪声水平
    'baseline_drift': 0.1,       # 基线漂移
}
```

#### 3. 模型配置

```python
MODEL_CONFIG = {
    'd_model': 128,              # 模型维度
    'nhead': 8,                  # 注意力头数
    'num_layers': 4,             # 编码器层数
    'dim_feedforward': 512,      # 前馈网络维度
    'dropout': 0.1,              # Dropout比例
}
```

#### 4. 训练配置

```python
TRAIN_CONFIG = {
    'epochs': 100,               # 训练轮数
    'batch_size': 16,            # 批次大小
    'learning_rate': 0.001,      # 学习率
    'patience': 15,              # 早停耐心值
    'min_delta': 0.0001,         # 最小改善量
}
```

---

## 常见问题

### Q1: 运行提示"ModuleNotFoundError"

**问题**: `ModuleNotFoundError: No module named 'torch'`

**解决方案**:
```bash
# 确保激活了正确的环境
conda activate transformer_env

# 重新安装依赖
pip install -r requirements.txt
```

---

### Q2: GPU不可用

**问题**: 想使用GPU但系统默认使用CPU

**解决方案**:
1. 检查GPU是否可用：
```python
import torch
print(torch.cuda.is_available())
```

2. 如果返回`False`，可能需要安装支持CUDA的PyTorch：
```bash
# 访问 https://pytorch.org/ 选择合适的版本
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

---

### Q3: 显示中文乱码

**问题**: matplotlib图表中文显示为方框

**解决方案**:
项目已内置中文字体配置（SimHei/Microsoft YaHei），如果仍有问题：

```python
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei']
plt.rcParams['axes.unicode_minus'] = False
```

---

### Q4: 内存不足

**问题**: `RuntimeError: CUDA out of memory` 或系统内存不足

**解决方案**:
1. 减小批次大小：
```python
# 在config.py中修改
BATCH_SIZE = 8  # 从16减到8
```

2. 使用CPU模式：
```python
DEVICE_MODE = 'cpu'
```

---

### Q5: 训练速度慢

**问题**: 训练一个epoch需要很长时间

**解决方案**:
1. 减少数据量进行快速测试：
```python
NUM_MIXTURES = 40  # 从80减到40
```

2. 减少模型复杂度：
```python
MODEL_CONFIG = {
    'd_model': 64,       # 从128减到64
    'num_layers': 2,     # 从4减到2
}
```

3. 启用GPU加速（如果可用）

---

### Q6: 预测结果不准确

**问题**: 模型预测效果不理想

**解决方案**:
1. 增加训练轮数：
```python
EPOCHS = 200  # 从100增加到200
```

2. 调整学习率：
```python
LEARNING_RATE = 0.0005  # 降低学习率
```

3. 增加数据量：
```python
NUM_MIXTURES = 160  # 增加到160
```

4. 检查数据预处理是否正确应用

---

### Q7: 如何保存和加载模型？

**保存模型**:
```python
torch.save(model.state_dict(), 'saved_models/my_model.pth')
```

**加载模型**:
```python
model = create_model()
model.load_state_dict(torch.load('saved_models/my_model.pth', weights_only=False))
model.eval()
```

---

### Q8: 如何自定义药物成分？

修改 `config.py`:
```python
COMPONENT_NAMES = [
    '阿司匹林',
    '对乙酰氨基酚',
    '咖啡因',
    '布洛芬',
    '萘普生',
    '您的新成分',  # 添加新成分
]
NUM_COMPONENTS = 6  # 更新成分数量
```

同时需要在 `data/data_generator.py` 中添加新成分的特征峰位置。

---

## 技术支持

### 获取帮助

1. **查看代码注释**: 所有文件都有详细的中文注释
2. **运行测试脚本**: `python quick_start.py`
3. **检查日志文件**: 查看 `logs/` 目录下的日志

### 日志信息

训练和预测过程会自动记录详细日志，便于问题排查。

---

## 附录

### 依赖包版本

| 包名 | 版本要求 | 用途 |
|------|---------|------|
| torch | ≥1.10.0 | 深度学习框架 |
| numpy | ≥1.21.0 | 数值计算 |
| matplotlib | ≥3.4.0 | 数据可视化 |
| scikit-learn | ≥1.0.0 | 机器学习工具 |
| scipy | ≥1.7.0 | 科学计算 |
| tqdm | ≥4.62.0 | 进度条 |

### 项目文件说明

| 文件/文件夹 | 说明 |
|------------|------|
| `config.py` | 全局配置文件 |
| `quick_start.py` | 快速开始脚本 |
| `models/transformer.py` | Transformer模型定义 |
| `models/positional_encoding.py` | 位置编码模块 |
| `data/data_generator.py` | 数据生成器 |
| `utils/dataset.py` | 数据集类 |
| `utils/metrics.py` | 评估指标 |
| `utils/preprocessing.py` | 数据预处理 |
| `saved_models/` | 保存的模型文件 |
| `results/` | 输出结果 |
| `logs/` | 日志文件 |

---

## 更新日志

### v1.0 (2025-10-27)
- ✅ 初始版本发布
- ✅ Transformer模型实现
- ✅ 多任务学习（成分识别+浓度预测）
- ✅ 数据生成器
- ✅ 完整的使用文档

---

**祝您使用愉快！如有问题，请参考上述常见问题或查看代码注释。**

